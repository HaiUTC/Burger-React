CREATE DATABASE QUANLYBANHANG

--TABLE KHACH HANG
CREATE TABLE KHACHHANG
(
	MAKH CHAR(10) NOT NULL,
	HOTEN NVARCHAR(30),
	SDT VARCHAR(10),
	DIACHI NVARCHAR(50),
	DOANHSO MONEY,
	CONSTRAINT PK_KH PRIMARY KEY(MAKH)
)
--TABLE NHAN VIEN
CREATE TABLE NHANVIEN
(
	MANV CHAR(10) NOT NULL,
	HOTEN NVARCHAR(30),
	CHUCVU NVARCHAR(20),
	NGAYSINH SMALLDATETIME,
	CONSTRAINT PK_NV PRIMARY KEY(MANV)
)

--TABLE SAN PHAM
CREATE TABLE SANPHAM
(
	MASP CHAR(10) NOT NULL,
	TENSP NVARCHAR(30),
	DVT VARCHAR(10),
	SIZE TINYINT,
	MAU NVARCHAR(10),
	HANG NVARCHAR(20),
	SOLUONG INT,
	GIA MONEY,
	CONSTRAINT PK_SP PRIMARY KEY(MASP)
)

--TABLE HOA DON
CREATE TABLE HOADON
(
	MAHD CHAR(10) NOT NULL,
	MAKH CHAR(10) NOT NULL,
	GIA MONEY,
	NB SMALLDATETIME,  --NGAY BAN
	NG SMALLDATETIME,	--NGAY GIAO
	CONSTRAINT PK_HD PRIMARY KEY(MAHD)
)

--TABLE GIAO HANG
CREATE TABLE GIAOHANG
(
	MAGH CHAR(10) NOT NULL,
	HOTEN NVARCHAR(30),
	SDT VARCHAR(10),
	PHI TINYINT,
	CONSTRAINT PK_GH PRIMARY KEY(MAGH)
)

--TABLE HOA DON CHINH
CREATE TABLE HDC
(
	MAHD CHAR(10) NOT NULL,
	MASP CHAR(10) NOT NULL,
	MAGH CHAR(10),
	SOLUONG TINYINT,
	CONSTRAINT PK_HDC PRIMARY KEY(MAHD,MASP,MAGH)
)

--ADD FOREIGN KEY
ALTER TABLE HOADON ADD CONSTRAINT FK_HD FOREIGN KEY(MAKH) REFERENCES KHACHHANG(MAKH)
ALTER TABLE HDC ADD CONSTRAINT FK_HDC01 FOREIGN KEY(MAHD) REFERENCES HOADON(MAHD)
ALTER TABLE HDC ADD CONSTRAINT FK_HDC02 FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)
ALTER TABLE HDC ADD CONSTRAINT FK_HDC03 FOREIGN KEY(MAGH) REFERENCES GIAOHANG(MAGH)

SET DATEFORMAT DMY

--SET VALUE 

--NHANVIEN
INSERT INTO NHANVIEN VALUES('NV01',N'Nguyễn Thanh Hải','QL','30/11/2000')
INSERT INTO NHANVIEN VALUES('NV02',N'Nguyễn Thanh Hà','NVBH','12/12/2001')
INSERT INTO NHANVIEN VALUES('NV03',N'Nguyễn Thanh Hùng','NVBH','06/07/2001')
INSERT INTO NHANVIEN VALUES('NV04',N'Nguyễn Thanh Ngọc','NVBH','04/08/1999')
INSERT INTO NHANVIEN VALUES('NV05',N'Nguyễn Thanh Tùng','NVBH','04/11/2002')
INSERT INTO NHANVIEN VALUES('NV06',N'Nguyễn Thanh Huyền','NVBH','12/11/2000')
INSERT INTO NHANVIEN VALUES('NV07',N'Nguyễn Thanh Bình','NVBH','31/10/2002')
INSERT INTO NHANVIEN VALUES('NV08',N'Nguyễn Thanh Minh','NVBH','24/06/1998')
INSERT INTO NHANVIEN VALUES('NV09',N'Nguyễn Thanh Nga','NVBH','19/01/2000')
INSERT INTO NHANVIEN VALUES('NV10',N'Nguyễn Thanh Mai','NVBH','28/02/2000')

--KHACH HANG
INSERT INTO KHACHHANG VALUES ('KH01',N'Nguyễn Thanh Hải','0123442',N'Hà Nội',99999)
INSERT INTO KHACHHANG VALUES ('KH02',N'Nguyễn Quang Huy','0123442',N'Hà Nội',9999)
INSERT INTO KHACHHANG VALUES ('KH03',N'Nguyễn Tiến Thành','0123442',N'TPHCM',9939)
INSERT INTO KHACHHANG VALUES ('KH04',N'Nguyễn Văn Phúc','0123442',N'Hà Nội',9929)
INSERT INTO KHACHHANG VALUES ('KH05',N'Nguyễn Tuấn Minh','0123442',N'Hà Nội',9299)
INSERT INTO KHACHHANG VALUES ('KH06',N'Nguyễn Văn Lợi','0123442',N'Thái Bình',9499)
INSERT INTO KHACHHANG VALUES ('KH07',N'Nguyễn Bội Hoằng','0123442',N'Thái Bình',899)
INSERT INTO KHACHHANG VALUES ('KH08',N'Nguyễn Tiến Hùng','0123442',N'Hà Nội',9899)
INSERT INTO KHACHHANG VALUES ('KH09',N'Nguyễn Thanh Minh','0123442',N'Hải Phòng',89999)
INSERT INTO KHACHHANG VALUES ('KH10',N'Nguyễn Minh Thanh','0123442',N'Thái Bình',39999)
INSERT INTO KHACHHANG VALUES ('KH11',N'Nguyễn Huyền Thanh','0123442',N'Hà Nội',29999)
INSERT INTO KHACHHANG VALUES ('KH12',N'Nguyễn Thanh Mai','0123442',N'Hải Phòng',3999)
INSERT INTO KHACHHANG VALUES ('KH13',N'Nguyễn An Huệ','0123442',N'Hà Nội',99349)
INSERT INTO KHACHHANG VALUES ('KH14',N'Nguyễn Phương Thảo','0123442',N'Hà Nội',9499)
INSERT INTO KHACHHANG VALUES ('KH15',N'Nguyễn Tiến Anh','0123442',N'TPHCM',99999)
INSERT INTO KHACHHANG VALUES ('KH16',N'Nguyễn Trung Anh','0123442',N'Hà Nội',9979)
INSERT INTO KHACHHANG VALUES ('KH17',N'Nguyễn Trung Thành','0123442',N'Thái Bình',9899)
INSERT INTO KHACHHANG VALUES ('KH18',N'Nguyễn Thanh Hà','0123442',N'Hà Nội',995)
INSERT INTO KHACHHANG VALUES ('KH19',N'Nguyễn Phương Thanh','0123442',N'Thái Bình',6999)
INSERT INTO KHACHHANG VALUES ('KH20',N'Nguyễn Ngọc Ánh','0123442',N'Hà Nội',99219)


--SAN PHAM
INSERT INTO SANPHAM VALUES('SP01',N'Nike 001',N'Đôi',41,N'Trắng','Nike',999,200)
INSERT INTO SANPHAM VALUES('SP02',N'Nike 002',N'Đôi',40,N'Trắng','Nike',995,300)
INSERT INTO SANPHAM VALUES('SP03',N'Nike 003',N'Đôi',42,N'Trắng','Nike',939,122)
INSERT INTO SANPHAM VALUES('SP04',N'Nike 004',N'Đôi',43,N'Trắng','Nike',929,210)
INSERT INTO SANPHAM VALUES('SP05',N'Nike 005',N'Đôi',41,N'Trắng','Nike',199,20)
INSERT INTO SANPHAM VALUES('SP06',N'Nike 006',N'Đôi',41,N'Trắng','Nike',929,2100)
INSERT INTO SANPHAM VALUES('SP07',N'Nike 007',N'Đôi',39,N'Trắng','Nike',959,1200)
INSERT INTO SANPHAM VALUES('SP08',N'Nike 008',N'Đôi',40,N'Trắng','Nike',9119,5200)
INSERT INTO SANPHAM VALUES('SP09',N'Nike 009',N'Đôi',40,N'Trắng','Nike',929,2600)
INSERT INTO SANPHAM VALUES('SP10',N'Nike 010',N'Đôi',41,N'Trắng','Nike',949,2700)
INSERT INTO SANPHAM VALUES('SP11',N'Nike 011',N'Đôi',41,N'Trắng','Nike',959,2080)
INSERT INTO SANPHAM VALUES('SP12',N'Nike 012',N'Đôi',44,N'Trắng','Nike',269,200)
INSERT INTO SANPHAM VALUES('SP13',N'Nike 013',N'Đôi',41,N'Trắng','Nike',299,2009)
INSERT INTO SANPHAM VALUES('SP14',N'Nike 014',N'Đôi',40,N'Trắng','Nike',99,2090)
INSERT INTO SANPHAM VALUES('SP15',N'Nike 015',N'Đôi',40,N'Trắng','Nike',959,300)
INSERT INTO SANPHAM VALUES('SP16',N'Nike 016',N'Đôi',41,N'Trắng','Nike',993,400)
INSERT INTO SANPHAM VALUES('SP17',N'Nike 017',N'Đôi',42,N'Trắng','Nike',991,500)
INSERT INTO SANPHAM VALUES('SP18',N'Nike 018',N'Đôi',42,N'Trắng','Nike',499,2600)
INSERT INTO SANPHAM VALUES('SP19',N'Nike 019',N'Đôi',39,N'Trắng','Nike',799,7200)
INSERT INTO SANPHAM VALUES('SP20',N'Nike 020',N'Đôi',40,N'Trắng','Nike',9339,23200)

UPDATE SANPHAM 
SET HANG  = 'Adidas'
WHERE SIZE = 40
--GIAO HANG
INSERT INTO GIAOHANG VALUES('GH01',N'Nguyễn Văn Giao','0230323',7)
INSERT INTO GIAOHANG VALUES('GH02',N'Nguyễn Văn Hàng','023323',3)
INSERT INTO GIAOHANG VALUES('GH03',N'Nguyễn Hàng Giao','030323',4)
INSERT INTO GIAOHANG VALUES('GH04',N'Nguyễn Giao Hàng','02323',5)
INSERT INTO GIAOHANG VALUES('GH05',N'Nguyễn Giao Giao','00323',10)
INSERT INTO GIAOHANG VALUES('GH06',N'Nguyễn Hàng Hàng','0130323',1)

--HOA DON
INSERT INTO HOADON VALUES('HD01','KH01',89,'06/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD02','KH01',111,'05/04/2021','12/04/2021')
INSERT INTO HOADON VALUES('HD03','KH04',23,'01/04/2021','13/04/2021')
INSERT INTO HOADON VALUES('HD04','KH05',3,'02/04/2021','14/04/2021')
INSERT INTO HOADON VALUES('HD05','KH07',45,'01/04/2021','12/04/2021')
INSERT INTO HOADON VALUES('HD06','KH09',21,'04/04/2021','08/04/2021')
INSERT INTO HOADON VALUES('HD07','KH10',56,'20/03/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD08','KH12',49,'07/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD09','KH02',39,'10/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD10','KH02',14,'28/03/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD11','KH02',23,'25/03/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD12','KH08',6,'06/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD13','KH09',45,'03/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD14','KH10',4,'02/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD15','KH11',893,'06/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD16','KH19',55,'07/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD17','KH20',44,'08/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD18','KH14',8239,'02/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD19','KH11',24,'02/04/2021','10/04/2021')
INSERT INTO HOADON VALUES('HD20','KH06',54,'01/04/2021','10/04/2021')


--Hóa đơn chính
INSERT INTO HDC VALUES('HD02','SP01','GH03',12)
INSERT INTO HDC VALUES('HD02','SP04','GH02',2)
INSERT INTO HDC VALUES('HD01','SP03','GH01',1)
INSERT INTO HDC VALUES('HD02','SP20','GH04',1)
INSERT INTO HDC VALUES('HD04','SP11','GH02',2)
INSERT INTO HDC VALUES('HD05','SP18','GH01',3)
INSERT INTO HDC VALUES('HD04','SP17','GH04',3)
INSERT INTO HDC VALUES('HD07','SP14','GH05',3)
INSERT INTO HDC VALUES('HD04','SP12','GH06',4)
INSERT INTO HDC VALUES('HD02','SP11','GH06',5)
INSERT INTO HDC VALUES('HD06','SP10','GH06',6)
INSERT INTO HDC VALUES('HD07','SP18','GH05',2)
INSERT INTO HDC VALUES('HD02','SP02','GH02',1)
INSERT INTO HDC VALUES('HD02','SP04','GH03',8)
INSERT INTO HDC VALUES('HD01','SP06','GH03',6)
INSERT INTO HDC VALUES('HD01','SP08','GH01',4)
INSERT INTO HDC VALUES('HD01','SP01','GH02',3)
INSERT INTO HDC VALUES('HD02','SP02','GH01',2)
INSERT INTO HDC VALUES('HD06','SP03','GH01',1)
INSERT INTO HDC VALUES('HD07','SP04','GH03',3)
INSERT INTO HDC VALUES('HD08','SP01','GH04',4)
INSERT INTO HDC VALUES('HD04','SP05','GH04',2)
INSERT INTO HDC VALUES('HD03','SP06','GH05',1)
INSERT INTO HDC VALUES('HD07','SP04','GH05',2)
INSERT INTO HDC VALUES('HD02','SP02','GH06',3)
INSERT INTO HDC VALUES('HD06','SP03','GH06',2)
INSERT INTO HDC VALUES('HD08','SP01','GH03',2)
INSERT INTO HDC VALUES('HD08','SP02','GH01',1)
INSERT INTO HDC VALUES('HD04','SP04','GH01',4)
INSERT INTO HDC VALUES('HD02','SP05','GH02',2)
INSERT INTO HDC VALUES('HD01','SP06','GH01',4)
INSERT INTO HDC VALUES('HD02','SP01','GH04',2)

-- Thực hiện câu truy vấn
--1. In ra sản phẩm (MASP,TENSP,SIZE) có size = 41
SELECT MASP,TENSP,SIZE
FROM SANPHAM
WHERE SIZE = 41
--2. In ra sản phẩm (MASP,TENSP,SIZE) có size >= 40 và giá từ 1000 đến 3000
SELECT MASP,TENSP,SIZE,GIA
FROM SANPHAM
WHERE SIZE >= 40
AND GIA BETWEEN 1000 AND 3000
--3. In ra sản phẩm (MASP,TENSP,HANG) có hãng là Nike hoặc adidas và giá từ 100 đến 500
SELECT MASP,TENSP,HANG,GIA
FROM SANPHAM
WHERE (HANG = 'Nike' OR HANG = 'Adidas') AND GIA BETWEEN 100 AND 500
--4. In ra số hóa đơn, giá trị được bán ra từ ngày 1/4/2021 đến 6/4/2021
SELECT MAHD, GIA
FROM HOADON
WHERE NB >= '1/4/2021' AND NB <= '6/4/2021'
--5. Sắp cếp trị giá hóa đơn theo thứ tự giá tăng dần
SELECT MAHD, NB, GIA
FROM HOADON
ORDER BY  GIA ASC
--6. Tìm khách hàng đã mua hàng ngày 6/4/2021
SELECT K.MAKH , HOTEN
FROM KHACHHANG K INNER JOIN HOADON H
ON K.MAKH = H.MAKH
WHERE NB = '6/4/2021'
--7. Tìm mã hóa đơn , mã giao hàng, tên người giao hàng tại hóa đơn có số lượng hàng = 3
SELECT H.MAHD,G.MAGH, HOTEN, SDT
FROM GIAOHANG G INNER JOIN HDC H
ON G.MAGH = H.MAGH
WHERE SOLUONG = 3
--8 . Tìm mã sp, tên sp,giá mà khách hàng tên 'Nguyễn Thanh Hải' mua từ ngày 4/4/2021 đến ngày 7/4/2021
SELECT DISTINCT S.MASP, TENSP, GIA
FROM SANPHAM S INNER JOIN HDC H
ON S.MASP = H.MASP
AND EXISTS(
	SELECT * 
	FROM HDC H INNER JOIN HOADON HD
	ON H.MAHD = HD.MAHD
	AND NB >= '4/4/2021' AND NB <= '7/4/2021' AND MAKH IN (
		SELECT HD.MAKH
		FROM HOADON HD INNER JOIN KHACHHANG K
		ON HD.MAKH = K.MAKH
		WHERE HOTEN = N'Nguyễn Thanh Hải' 
	) AND S.MASP = H.MASP
)
--9. Tìm tên, số điện thoại ng giao hàng giao hàng giao ngày 4/4/2021
SELECT DISTINCT G.MAGH, HOTEN, SDT
FROM GIAOHANG G INNER JOIN HDC H
ON G.MAGH = H.MAGH
WHERE EXISTS(
	SELECT * 
	FROM HDC H INNER JOIN HOADON HD
	ON H.MAHD = HD.MAHD
	WHERE NB = '4/4/2021'
	AND G.MAGH = H.MAGH
) 
--10. In ra danh sách sản phẩm không bán được 
SELECT S.MASP, TENSP
FROM SANPHAM S 
WHERE NOT EXISTS(
	SELECT *
	FROM SANPHAM S1 INNER JOIN HDC H
	ON S1.MASP = H.MASP
	AND S1.MASP = S.MASP
)